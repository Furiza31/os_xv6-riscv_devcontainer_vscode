<!DOCTYPE html>
<html>
<head>
<title>report.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="compte-rendu">Compte Rendu</h1>
<p><strong>Nom</strong> : Hugo Wendjaneh, Louis Maury, Fouad Id Gouahmane
<strong>Date</strong> : 15-04-2025
<strong>Sujet</strong> : Systèmes d'exploitation
<strong>Contexte</strong> : OS XV6 Risc V</p>
<h2 id="1-objectif">1. Objectif</h2>
<p>L’objectif du cours est de présenter les concepts et les techniques fondamentales utilisées dans les systèmes d’exploitation modernes. Ces TPs porteront en particulier sur : la gestion des processus (processus, thread, ordonnancement, synchronisation), la communication interprocessus (IPC), la gestion mémoire (segmentation, pagination et mémoire virtuelle) ainsi que le système de fichier.</p>
<h2 id="2-quest-ce-que-le-xv6">2. Qu'est-ce que le XV6 ?</h2>
<p>XV6 est un système d'exploitation éducatif basé sur Unix, conçu pour être simple et facile à comprendre. Il est écrit en C et assembleur, et il est utilisé pour enseigner les concepts fondamentaux des systèmes d'exploitation. XV6 est une version simplifiée de Unix Version 6 (V6), qui a été développé dans les années 1970.</p>
<h2 id="3-r%C3%A9partition-des-taches">3. Répartition des taches</h2>
<table>
<thead>
<tr>
<th>Nom</th>
<th>Tâches</th>
</tr>
</thead>
<tbody>
<tr>
<td>Louis Maury</td>
<td>Implémentation de la commande <code>pstree</code></td>
</tr>
<tr>
<td>Hugo Wendjaneh</td>
<td>Implémentation des commandes <code>psync_tst</code> et <code>pmem_test</code></td>
</tr>
<tr>
<td>Fouad Id Gouahmane</td>
<td>Implémentation de la commande <code>phierarchy_tst</code></td>
</tr>
</tbody>
</table>
<h2 id="3-tp-2-r%C3%A9alisation">3. TP 2: Réalisation</h2>
<h3 id="31-cr%C3%A9ation-dune-commande-pstree">3.1 Création d'une commande pstree</h3>
<p>Implémenter la commande UNIX pstree. Cette commande doit permettre l'affichage d'un &quot;pseudo&quot; arbre qui permet de visualiser les liens de parentées entre les processus. Votre implémentation sera simplifiée afin de limiter les modifications au sein du kernel de XV6. Ainsi plusieurs branches pourront être redondantes.</p>
<ul>
<li><code>user/Makefile</code> : Ajout de la commande pstree dans le Makefile pour compilation.</li>
</ul>
<pre class="hljs"><code><div>	$U/_pstree\
</div></code></pre>
<ul>
<li><code>user/pstree.c</code> : Implémentation de la commande pstree.</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"kernel/types.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"kernel/stat.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"user/user.h"</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span>

</span>{
  <span class="hljs-keyword">if</span>(argc != <span class="hljs-number">1</span>){
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Usage: pstree\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  }
  pstree();
  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}
</div></code></pre>
<ul>
<li><code>user/user.h</code> : Ajout de la déclaration de la fonction <code>pstree()</code>.</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pstree</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;
</div></code></pre>
<ul>
<li><code>user/usys.pl</code> : Ajout de la déclaration de la fonction <code>pstree()</code> dans le fichier usys.pl pour la génération des appels système.</li>
</ul>
<pre class="hljs"><code><div>entry(<span class="hljs-string">"pstree"</span>);
</div></code></pre>
<ul>
<li><code>kernel/proc.c</code> : Ajout de la fonction <code>proctree()</code> dans le fichier proc.c pour la gestion des processus.</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">void</span>
<span class="hljs-title">proctree</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span>;</span>
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);
  <span class="hljs-keyword">for</span> (p = proc; p &lt; &amp;proc[NPROC]; p++) {
    <span class="hljs-keyword">if</span> (p-&gt;state == UNUSED)
      <span class="hljs-keyword">continue</span>;
    <span class="hljs-keyword">if</span> (p-&gt;parent == <span class="hljs-number">0</span>) {
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"PROCESS %s\tPID: %d"</span>, p-&gt;name, p-&gt;pid);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"PARENT %s\tPID: %d\n└── PROCESS %s\tPID: %d"</span>, p-&gt;parent-&gt;name, p-&gt;parent-&gt;pid, p-&gt;name, p-&gt;pid);
    }
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);
  }
}
</div></code></pre>
<ul>
<li><code>kernel/defs.h</code> : Ajout de la déclaration de la fonction <code>proctree()</code> dans le fichier defs.h pour la gestion des processus.</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">proctree</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;
</div></code></pre>
<ul>
<li><code>kernel/sysproc.c</code> : Ajout de la fonction <code>proctree()</code> dans le fichier sysproc.c pour la gestion des appels système.</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-function">uint64 <span class="hljs-title">sys_pstree</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
  proctree();
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<ul>
<li><code>kernel/syscall.c</code> : Ajout de la déclaration de la fonction <code>sys_pstree()</code> dans le fichier syscall.c pour la gestion des appels système.</li>
</ul>
<pre class="hljs"><code><div>[SYS_pstree]  sys_pstree
</div></code></pre>
<ul>
<li><code>kernel/syscall.h</code> : Ajout de la déclaration de la fonction <code>SYS_pstree</code> dans le fichier syscall.h pour la gestion des appels système à l'aide des identifiants commandes (23).</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SYS_pstree 23</span>
</div></code></pre>
<h3 id="32-synchronisation-des-processus">3.2 Synchronisation des processus</h3>
<p>On veut tester la synchronisation entre processus parent/enfant. On se base sur l'affichage d'un message partagé entre deux processus. Vous allez créer un programme qui contiendra le processus parent qui attendra que son processus fils ait affiché la première partie du message pour affcicher la seconde. Il sera possible de ne pas respecter la synchronisation comme parametre du programme.</p>
<ul>
<li><code>user/psync_tst.c</code>: Implémentation du programme de test de synchronisation entre processus.</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"kernel/types.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"kernel/stat.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"user/user.h"</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span>
<span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span>
</span>{
  <span class="hljs-keyword">int</span> wait_flag = <span class="hljs-number">1</span>; <span class="hljs-comment">// Default wait for child</span>

  <span class="hljs-keyword">if</span>(argc &gt; <span class="hljs-number">2</span>){
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Usage:\n\ttpsync_tst\n\tpsync_tst [1 or 2]\n\t0: do not wait for child, 1: wait for child\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  }

  <span class="hljs-comment">// If a parameter is provided, check its value.</span>
  <span class="hljs-keyword">if</span>(argc == <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">int</span> param = atoi(argv[<span class="hljs-number">1</span>]);
    <span class="hljs-keyword">if</span>(param != <span class="hljs-number">1</span> &amp;&amp; param != <span class="hljs-number">0</span>){
      <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Usage:\n\ttpsync_tst\n\tpsync_tst [1 or 0]\n\t0: do not wait for child, 1: wait for child\n"</span>);
      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    wait_flag = (param == <span class="hljs-number">1</span>);
  }

  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"-- Test process synchronisation --\n"</span>);

  <span class="hljs-keyword">int</span> pid = fork();

  <span class="hljs-keyword">if</span>(pid &lt; <span class="hljs-number">0</span>){
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Humm, something went wrong. Fork failed\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">0</span>){
    <span class="hljs-comment">// Child process</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Hi, I am the child process with pid %d\n"</span>, getpid());
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"I will sleep for 2 seconds\n"</span>);
    sleep(<span class="hljs-number">2</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"I end my life now\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Parent process</span>
    <span class="hljs-keyword">if</span>(wait_flag) {
      <span class="hljs-keyword">int</span> child_pid = wait(<span class="hljs-number">0</span>);
      <span class="hljs-keyword">if</span>(child_pid &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Humm, something went wrong. The parent has no child process.\n"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
      }
    }
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Hi, I am the parent process with pid %d\n"</span>, getpid());
    <span class="hljs-keyword">if</span>(wait_flag)
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"I was waiting for my child process to finish.\n"</span>);
    <span class="hljs-keyword">else</span>
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"I did not wait for my child process.\n"</span>);
  }
  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}
</div></code></pre>
<ul>
<li><code>Makefile</code>: Ajout de la commande psync_tst dans le Makefile pour compilation.</li>
</ul>
<pre class="hljs"><code><div>  $U/_psync_tst\
</div></code></pre>
<p>Ici nous avons implémenté un programme de test de synchronisation entre processus. Le programme prend un argument qui détermine si le processus parent doit attendre la fin du processus enfant avant de continuer son exécution. Si l'argument est 1, le parent attend la fin du fils, sinon il continue sans attendre.
Le programme crée un processus enfant qui affiche un message, attend 2 secondes, puis se termine. Le processus parent affiche également un message et indique s'il a attendu la fin du processus enfant ou non.</p>
<p>Si l'argment de la fonction est 0, alors le parent ne doit pas attendre et peut continuer son exécution immédiatement. Cela crée des problème d'affichage, car le parent veux afficher sont message en même temp que le fils. Il est donc possible d'avoir un affichage comme celui-ci :</p>
<pre class="hljs"><code><div>Hi, HiI am ,t heI p araent prm theo cess wcihth pidi l7d p
roI cdeid snots  wawiitht  pfiord  my8
cIh ilwdi lprl socleeseps.
for 2 second$ s
I end my life now
</div></code></pre>
<p>Nous pouvons voir que les deux processus essaient d'afficher en même temps, ce qui crée un affichage confus. Cela est dû à la nature concurrente des processus et à l'absence de synchronisation entre eux.</p>
<h4 id="321-diagrame-uml-repr%C3%A9sentant-la-concurrence-entre-les-processus">3.2.1 Diagrame UML représentant la concurrence entre les processus</h4>
<p><img src="./images/synchronisation_processus.puml" alt="Synchronisation processus"></p>
<h3 id="33-parentalit%C3%A9-des-processus">3.3 Parentalité des processus</h3>
<p>L'objectif de cette partie est de vérifier la conformité de la parentalité des processus dans le système d'exploitation XV6. Nous allons créer un programme qui génère une hiérarchie de processus en fonction du nombre d'enfants et du nombre de générations spécifiés en arguments.</p>
<ul>
<li><code>user/phierarchy.c</code>: Implémentation du programme de test de parentalité des processus.</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"kernel/types.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"kernel/stat.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"user/user.h"</span></span>

<span class="hljs-comment">/**
  * run pstree command in child process
  * and wait for it to finish
  * @param nchilds number of child processes to create
  * @return void
*/</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test_child_processes</span><span class="hljs-params">(<span class="hljs-keyword">int</span> nchilds)</span> </span>{
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"---Test process relationship with %d child\n\n"</span>, nchilds);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; nchilds; i++) {
    <span class="hljs-keyword">int</span> pid = fork();
    <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Error: fork failed\n"</span>);
      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"child %d created with PID %d\n\n"</span>, i, getpid());
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"child %d execute pstree and die\n"</span>, i);

      <span class="hljs-keyword">char</span> *args[] = {<span class="hljs-string">"pstree"</span>, <span class="hljs-number">0</span>};
      exec(args[<span class="hljs-number">0</span>], args);
      <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"exec pstree failed\n"</span>);
      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    wait(<span class="hljs-number">0</span>);
  }
}
<span class="hljs-comment">/**
  * test genealogy of processes
  * @param gen number of generations
  * @param max_gen maximum number of generations
  * @param current_gen current generation
  * @return void
*/</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test_genealogy</span><span class="hljs-params">(<span class="hljs-keyword">int</span> gen, <span class="hljs-keyword">int</span> max_gen, <span class="hljs-keyword">int</span> current_gen)</span> </span>{
  <span class="hljs-keyword">if</span> (current_gen &gt;= max_gen) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"---Test process genealogy on %d's'th generation\n"</span>, current_gen);

  <span class="hljs-keyword">int</span> pid = fork();
  <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Error: fork failed\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"child %d created with PID %d from parent PID %d\n\n"</span>, current_gen, getpid(), getppid());

    <span class="hljs-comment">// If we're at the last generation, show the complete hierarchy</span>
    <span class="hljs-keyword">if</span> (current_gen == max_gen - <span class="hljs-number">1</span>) {
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\nLet's see process hierarchy with pstree:\n"</span>);
      <span class="hljs-keyword">int</span> ps_pid = fork();
      <span class="hljs-keyword">if</span> (ps_pid &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Error: fork failed\n"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ps_pid == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">char</span> *args[] = {<span class="hljs-string">"pstree"</span>, <span class="hljs-number">0</span>};
        exec(args[<span class="hljs-number">0</span>], args);
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"exec pstree failed\n"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
      }
      wait(<span class="hljs-number">0</span>);
    }

    test_genealogy(gen, max_gen, current_gen + <span class="hljs-number">1</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
  }

  wait(<span class="hljs-number">0</span>);
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span> </span>{
  <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">3</span>) {
      <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Usage: phierarchy &lt;number of childs&gt; &lt;number of generation&gt;\n"</span>);
      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">int</span> nchilds = atoi(argv[<span class="hljs-number">1</span>]);
  <span class="hljs-keyword">int</span> ngen = atoi(argv[<span class="hljs-number">2</span>]);
  <span class="hljs-keyword">if</span> (nchilds &lt; <span class="hljs-number">1</span> || ngen &lt; <span class="hljs-number">1</span>) {
      <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Error: number of childs and generation must be greater than 0\n"</span>);
      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  }

  test_child_processes(nchilds);
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"All child must be terminated : see that with pstree\n"</span>);

  <span class="hljs-keyword">int</span> pid = fork();
  <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"Error: fork failed\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">char</span> *args[] = {<span class="hljs-string">"ps"</span>, <span class="hljs-number">0</span>};
    exec(args[<span class="hljs-number">0</span>], args);
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"exec ps failed\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  }

  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);

  wait(<span class="hljs-number">0</span>);
  test_genealogy(nchilds, ngen, <span class="hljs-number">0</span>);

  wait(<span class="hljs-number">0</span>);
  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}
</div></code></pre>
<ul>
<li><code>Makefile</code>: Ajout de la commande phierarchy dans le Makefile pour compilation.</li>
</ul>
<pre class="hljs"><code><div>  $U/_phierarchy\
</div></code></pre>
<p>Le programme <code>phierarchy</code> permet de tester la conformité de la parentalité des processus dans le système d'exploitation XV6. Il génère une hiérarchie de processus en fonction du nombre d'enfants et du nombre de générations spécifiés en arguments. Le programme crée d'abord un certain nombre de processus enfants, puis il teste la généalogie des processus en créant des processus enfants.</p>
<p>Le programme affiche également la hiérarchie des processus à l'aide de la commande <code>pstree</code> pour vérifier la conformité de la parentalité. Il est important de noter que le programme utilise des appels système pour créer des processus et exécuter des commandes, ce qui est typique dans un système d'exploitation comme XV6.</p>
<h4 id="331-diagrame-uml-repr%C3%A9sentant-la-parentalit%C3%A9-entre-les-processus">3.3.1 Diagrame UML représentant la parentalité entre les processus</h4>
<p><img src="./images/parentalite_processus.puml" alt="Parentalité processus"></p>
<h3 id="34-cloisonnement-des-donn%C3%A9es-entre-processus">3.4 Cloisonnement des données entre processus</h3>
<p>L'objectif est de tester le bon fonctionnement de XV6 pour le cloisonnement des données entre processus.</p>
<p>Ce programme va créer des données côté parent et vérifier le cloisonnement avec les données de l'enfant. Vérifiez aussi les valeurs des données issus du parent à partir de l'enfant.</p>
<ul>
<li><code>user/pmem_test.c</code>: Implémentation du programme de test de cloisonnement des données entre processus.</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"kernel/types.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"kernel/stat.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"user/user.h"</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span> </span>{
  <span class="hljs-keyword">int</span> parent_int = <span class="hljs-number">10</span>;
  <span class="hljs-keyword">char</span> parent_msg[<span class="hljs-number">50</span>] = <span class="hljs-string">"parent message"</span>;

  <span class="hljs-keyword">int</span> p[<span class="hljs-number">2</span>];
  <span class="hljs-keyword">if</span>(pipe(p) &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"pipe creation failed\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  }

  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"--- Test du cloisonnement de données entre processus\n\n"</span>);
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Parent datas : int parent_int = %d | char *parent_msg = \"%s\"\n\n"</span>,
         parent_int, parent_msg);

  <span class="hljs-keyword">int</span> pid = fork();
  <span class="hljs-keyword">if</span>(pid &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"fork failed\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">if</span>(pid == <span class="hljs-number">0</span>) { <span class="hljs-comment">// Child process</span>
    <span class="hljs-built_in">close</span>(p[<span class="hljs-number">0</span>]);

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"we are in child and we have all copies of data's parent\n"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Datas from parent:\n"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"parent_int : %d\n"</span>, parent_int);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"parent_msg : %s\n\n"</span>, parent_msg);

    <span class="hljs-comment">// Modify the values</span>
    parent_int += <span class="hljs-number">10</span>;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"child add 10 to parent_int variable. It should be 20 now\n"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"from child, parent_int : %d\n"</span>, parent_int);

    <span class="hljs-built_in">strcpy</span>(parent_msg, <span class="hljs-string">"changed by child ;)"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"child change parent_msg variable. It should be \"changed by child ;)\" now from child, parent_msg : %s\n\n"</span>, parent_msg);

    <span class="hljs-built_in">write</span>(p[<span class="hljs-number">1</span>], <span class="hljs-string">"done"</span>, <span class="hljs-number">4</span>);
    <span class="hljs-built_in">close</span>(p[<span class="hljs-number">1</span>]);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
  } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// Parent process</span>
    <span class="hljs-built_in">close</span>(p[<span class="hljs-number">1</span>]);

    <span class="hljs-keyword">char</span> buf[<span class="hljs-number">10</span>];
    <span class="hljs-built_in">read</span>(p[<span class="hljs-number">0</span>], buf, <span class="hljs-keyword">sizeof</span>(buf));
    <span class="hljs-built_in">close</span>(p[<span class="hljs-number">0</span>]);

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\nparent : child exited\n"</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"from parent : parent_int : %d\n"</span>, parent_int);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"from parent : parent_msg : %s\n\n"</span>, parent_msg);

    wait(<span class="hljs-number">0</span>);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<ul>
<li><code>Makefile</code>: Ajout de la commande pmem_test dans le Makefile pour compilation.</li>
</ul>
<pre class="hljs"><code><div>  $U/_pmem_test\
</div></code></pre>
<p>Le programme <code>pmem_test</code> teste le cloisonnement des données entre processus dans le système d'exploitation XV6. Il crée un processus parent qui initialise des données, puis crée un processus enfant qui tente de modifier ces données. Le programme vérifie si les modifications apportées par l'enfant affectent les données du parent, ce qui permet de tester le cloisonnement des données entre les deux processus.</p>
<h4 id="341-diagrame-uml-repr%C3%A9sentant-le-cloisonnement-des-donn%C3%A9es-entre-les-processus">3.4.1 Diagrame UML représentant le cloisonnement des données entre les processus</h4>
<p><img src="./images/cloisonnement_processus.puml" alt="Cloisonnement des données entre processus"></p>
<h2 id="8-annexes-et-r%C3%A9f%C3%A9rences">8. Annexes et Références</h2>
<h3 id="81-lancer-le-projet">8.1 Lancer le projet.</h3>
<ul>
<li>Installer vscode (https://code.visualstudio.com/)</li>
<li>Installer l'extention pack &quot;Dev containers&quot;</li>
<li>Installer docker</li>
<li>Ouvrer VSCode dans le dossier du projet</li>
<li>Cliquer sur la notification: &quot;Ouvrir le project dans dev container&quot;</li>
<li>Lancer le projet: <code>make qemu</code></li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>Au travers de ces travaux pratiques sur XV6, nous avons pu explorer et implémenter plusieurs concepts fondamentaux des systèmes d'exploitation. En développant des commandes comme <code>pstree</code>, <code>psync_tst</code>, <code>phierarchy_tst</code> et <code>pmem_test</code>, nous avons mis en œuvre des fonctionnalités liées à la gestion des processus, à leur synchronisation, à la parentalité, ainsi qu'au cloisonnement mémoire.</p>
<p>Ces exercices nous ont permis de mieux comprendre le comportement des processus dans un environnement système, notamment la façon dont ils interagissent entre eux, leur hiérarchie et leur indépendance en mémoire. En manipulant directement le code source du noyau de XV6, nous avons également pris conscience des enjeux liés à la conception d'un système d'exploitation, et de la complexité sous-jacente à des fonctionnalités qui paraissent simples à l'utilisateur final.</p>
<p>Ce projet fut donc une excellente opportunité de mettre en pratique nos connaissances théoriques, tout en nous familiarisant avec les mécanismes internes d’un OS minimaliste mais complet. Ces acquis constituent une base solide pour aborder des systèmes plus complexes dans le futur.</p>

</body>
</html>
